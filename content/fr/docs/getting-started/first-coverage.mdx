import { Steps, Callout, Cards } from "nextra/components";

# Première donnée de couverture

> [!NOTE]
>
> Canyon fournit [des guides d'installation pour les frameworks courants](/docs/installation/getting-started) pour vous aider à démarrer rapidement.

Suivez ces étapes pour effectuer votre premier rapport de données de couverture :

## Commencer avec un nouveau projet

<Steps>
  ### Installation

Dans le développement frontend ingénierisé et modulaire, Babel est indispensable. Pour un projet Babel, il vous suffit d'installer deux plugins Babel pour démarrer rapidement.

```sh npm2yarn
npm install babel-plugin-istanbul babel-plugin-canyon -D
```

Ajoutez les plugins [`istanbul`](https://www.npmjs.com/package/babel-plugin-istanbul) et [`canyon`](https://www.npmjs.com/package/babel-plugin-canyon) dans votre [fichier de configuration Babel](https://babeljs.io/docs/config-files#configuration-file-types) :

  ```js filename="babel.config.js" {3,4} copy
  module.exports = {
    plugins: [
      'istanbul',
      'canyon'
      // Notez l'ordre des plugins, le plugin canyon doit être après le plugin istanbul
      ],
  };
  ```

### Vérification

Une fois la configuration terminée, démarrez le projet et affichez **window.\_\_coverage\_\_** dans la console. Si la sortie correspond à l'image ci-dessous, cela signifie que l'instrumentation du code a réussi.

 ![coverage-canyon-console](https://cdn.jsdelivr.net/gh/canyon-project/assets/docs/static/docs/getting-started/first-coverage/coverage-canyon-console.png)

### Configuration des variables d'environnement CI

Dans l'environnement CI, nous devons configurer certaines variables d'environnement pour rapporter les données de couverture.

> [!TIP]
>
> Canyon détecte les variables de pipeline lors de la compilation, nous prenons en charge plusieurs [fournisseurs de pipeline](/docs/reference/provider).<br/>Votre fournisseur de pipeline n'est pas pris en charge ? Essayez une [configuration explicite](/docs/ecosystem/babel-plugin-canyon#configuration).


1. `DSN` et `REPORTER`

- **DSN** : Adresse du service de rapport de données de couverture.
- **REPORTER** : Token utilisateur, disponible dans la page de paramètres de Canyon.

2. Configuration des variables de la plateforme CI

 ![gitlab](https://cdn.jsdelivr.net/gh/canyon-project/assets/docs/static/docs/getting-started/first-coverage/gitlab-var-config.png)

<Callout type="info" emoji="ℹ️">
  L'ID du projet, la branche et le SHA n'ont pas besoin d'être configurés manuellement, le plugin Canyon détectera automatiquement les variables d'environnement du pipeline.
</Callout>

  ### Mettre à jour les conditions d'activation du plugin Babel

  __Au stade CI, nous devons contrôler les conditions d'activation des plugins pour éviter l'instrumentation sur la branche de production.__

  ```js {2,3} copy
  module.exports = {
    plugins: (process.env.CI &&
              process.env.CI_COMMIT_REF_NAME !== 'release')
              ? [
                'canyon',
                'istanbul'
              ]:[],
  };
  ```

  ### Rapporter les données de couverture

  Attendez la fin de l'exécution CI, puis la page est déployée dans l'environnement de test.

  À ce stade, les données de couverture sont stockées dans le navigateur. Au fur et à mesure des opérations de l'utilisateur ou de l'exécution des tests d'automatisation UI, les données window.__coverage___ s'accumulent.

  En rapportant ces données sans erreur au serveur Canyon, vous pouvez afficher en temps réel les données de couverture.


  Voici plusieurs méthodes pour rapporter les données de couverture :

  <Cards>
  <Cards.Card
    title="Tests d'automatisation UI"
    href="/docs/end-to-end-testing/playwright"
  />
  <Cards.Card
    title="Tests manuels"
    href="/docs/ecosystem/canyon-extension"
  />
</Cards>
</Steps>

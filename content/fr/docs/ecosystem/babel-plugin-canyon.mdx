import { GithubOutlined } from "@ant-design/icons";
import { Button } from "antd";

# babel-plugin-canyon

<div className={'h-10'}></div>

<Button target={'_blank'} href={'https://github.com/canyon-project/canyon/tree/main/plugins/babel-plugin-canyon'} icon={<GithubOutlined />} size={'small'}>Source</Button>

Un plugin Babel qui détecte les variables d'environnement CI. Il complète l'instrumentation du code avec istanbuljs.

## Utilisation

Installation :

```sh
npm install --save-dev babel-plugin-canyon
```

Ajoutez ces configurations dans `babel.config.js` :

```js
module.exports = {
  plugins:
    process.env.CI_COMMIT_REF_NAME === "test-coverage"
      ? ["istanbul", "canyon"]
      : [],
      // Notez l'ordre des plugins, le plugin canyon doit être après le plugin istanbul
};
```

Il fait deux choses :

1. Détecter les variables de pipeline CI
2. Vérifier le produit d'instrumentation d'istanbul de l'étape précédente et le sauvegarder localement (lorsque keepMap est false)

## Configuration

babel.config.js

```js
module.exports = {
  plugins: [
    "istanbul",
    [
      "canyon",
      {
        // #region == Étape 1: Configuration des variables CI ou configuration manuelle
        dsn: "http://yourdomain.com/coverage/client", // Adresse de rapport de couverture, la clé pour détecter la variable de pipeline CI est DSN
        reporter: "your_token", // Token utilisateur pour différencier les utilisateurs, la clé pour détecter la variable de pipeline CI est REPORTER
        // #endregion
        // #region == Étape 2: Détection automatique du fournisseur CI, généralement pas besoin de configuration manuelle, consultez la documentation Support Provider pour plus de détails
        projectID: "230614", // ID du dépôt
        sha: "xxxxxxxxx", // SHA de commit Git
        branch: "master", // Branche du dépôt Git
        // #endregion
        // #region == Étape 3: Configuration supplémentaire de couverture (optionnel)
        reportID: "case_id", // Pour différencier les différents cas de test
        compareTarget: "develop", // Cible de comparaison, utilisée comme ligne de base pour le SHA actuel, pour calculer la couverture des lignes modifiées
        // #endregion
        // #region == Étape 4: Séparation des données hit et map (optionnel)
        keepMap: true, // Conserver la map de couverture, optionnel, par défaut true, lorsque false, génère un fichier .canyon_output !!!
        // #endregion
        // #region == Étape 5: Autres configurations (optionnel)
        instrumentCwd: "/path/to", // Répertoire de travail pour l'instrumentation, peut nécessiter une configuration manuelle en mode multi-dépôts
        provider: "gitlab", // Fournisseur de code source (optionnel), par défaut gitlab
        oneByOne: false, // Configurer le serveur proxy, optionnel, par défaut false. Lorsqu'il est true, rapporte les données de couverture initiales de chaque fichier une par une pendant la compilation. Peut également être une configuration de serveur proxy.
        // #endregion
      },
    ],
  ],
};
```

| Option        | Description                                                                                                  | Requis                                         | Valeur par défaut |
| ------------- | ------------------------------------------------------------------------------------------------------------ | ---------------------------------------------- | ----------------- |
| dsn           | Adresse de rapport de couverture, la clé pour détecter la variable de pipeline CI est DSN                     | Oui (selon la configuration des variables CI ou la configuration manuelle) | Aucune            |
| reporter      | Token utilisateur pour différencier les utilisateurs, la clé pour détecter la variable de pipeline CI est REPORTER | Oui (selon la configuration des variables CI ou la configuration manuelle) | Aucune            |
| projectID     | ID du dépôt                                                                                                  | Généralement pas besoin de configuration manuelle (détection automatique du fournisseur CI) | Aucune            |
| sha           | SHA de commit Git                                                                                            | Généralement pas besoin de configuration manuelle (détection automatique du fournisseur CI) | Aucune            |
| branch        | Branche du dépôt Git                                                                                         | Généralement pas besoin de configuration manuelle (détection automatique du fournisseur CI) | Aucune            |
| reportID      | Pour différencier les différents cas de test                                                                  | Optionnel                                      | Aucune            |
| compareTarget | Cible de comparaison, utilisée comme ligne de base pour le SHA actuel, pour calculer la couverture des lignes modifiées | Optionnel                                      | Aucune            |
| keepMap       | Conserver la map de couverture, optionnel, par défaut true, lorsque false, génère un fichier .canyon_output  | Optionnel                                      | true              |
| instrumentCwd | Répertoire de travail pour l'instrumentation, peut nécessiter une configuration manuelle en mode multi-dépôts | Optionnel                                      | process.cwd()     |
| provider      | Fournisseur de code source (optionnel), par défaut gitlab                                                    | Optionnel                                      | gitlab            |
| oneByOne      | Configurer le serveur proxy, optionnel, par défaut false. Lorsqu'il est true, rapporte les données de couverture initiales de chaque fichier une par une pendant la compilation. Peut également être une configuration de serveur proxy. | Optionnel                                      | false             |

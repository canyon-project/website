import { GithubOutlined } from "@ant-design/icons";
import { Button } from "antd";

# babel-plugin-canyon

<div className={'h-10'}></div>

<Button target={'_blank'} href={'https://github.com/canyon-project/canyon/tree/main/plugins/babel-plugin-canyon'} icon={<GithubOutlined />} size={'small'}>Source</Button>

CI 환경 변수를 감지하기 위한 Babel 플러그인입니다. istanbuljs와 함께 코드 계측을 완성합니다.

## 사용법

설치:

```sh
npm install --save-dev babel-plugin-canyon
```

`babel.config.js`에 다음 설정을 추가하세요:

```js
module.exports = {
  plugins:
    process.env.CI_COMMIT_REF_NAME === "test-coverage"
      ? ["istanbul", "canyon"]
      : [],
      // 플러그인 순서에 주의하세요. canyon 플러그인은 istanbul 플러그인 이후에 위치해야 합니다.
};
```

이 플러그인은 두 가지 작업을 수행합니다:

1. CI 파이프라인 변수 감지
2. 이전 단계의 istanbul 계측 결과를 확인하고 로컬에 저장(keepMap이 false일 때)

## 설정

babel.config.js

```js
module.exports = {
  plugins: [
    "istanbul",
    [
      "canyon",
      {
        // #region == Step 1: CI 변수 설정 또는 수동 설정
        dsn: "http://yourdomain.com/coverage/client", // 커버리지 보고 주소, CI 파이프라인 변수의 키는 DSN
        reporter: "your_token", // 사용자 토큰, 다른 사용자를 구분하기 위해 사용, CI 파이프라인 변수의 키는 REPORTER
        // #endregion
        // #region == Step 2: CI Provider 자동 감지, 일반적으로 수동 설정이 필요하지 않음, 자세한 내용은 Support Provider 문서 참조
        projectID: "230614", // 저장소 ID
        sha: "xxxxxxxxx", // Git Commit SHA
        branch: "master", // Git 저장소 브랜치
        // #endregion
        // #region == Step 3: 커버리지 추가 기능 설정(선택 사항)
        reportID: "case_id", // 다른 테스트 케이스를 구분하기 위해 사용
        compareTarget: "develop", // 비교 대상, 현재 SHA의 기준선으로 사용되며 변경된 라인의 커버리지를 계산하는 데 사용
        // #endregion
        // #region == Step 4: hit와 map 데이터 분리(선택 사항)
        keepMap: true, // coverage map 유지, 선택 사항, 기본값은 true, false일 경우 .canyon_output 파일이 생성됩니다!!!
        // #endregion
        // #region == Step 5: 기타 설정(선택 사항)
        instrumentCwd: "/path/to", // 계측 작업 디렉토리, 다중 저장소 모드에서는 수동 설정이 필요할 수 있음
        provider: "gitlab", // 소스 코드 provider(선택 사항), 기본값은 gitlab
        oneByOne: false, // 프록시 서버 설정, 선택 사항, 기본값은 false. true일 경우 컴파일 시 각 파일의 초기 커버리지 데이터를 개별적으로 보고합니다. 프록시 서버 설정일 수도 있습니다.
        // #endregion
      },
    ],
  ],
};
```

| 설정 항목      | 설명                                                                                                          | 필수 여부                                      | 기본값        |
| ------------- | ------------------------------------------------------------------------------------------------------------- | ---------------------------------------------- | ------------- |
| dsn           | 커버리지 보고 주소, CI 파이프라인 변수의 키는 DSN                                                              | 예(상황에 따라 CI 변수 설정 또는 수동 설정에서 작성) | 없음          |
| reporter      | 사용자 토큰, 다른 사용자를 구분하기 위해 사용, CI 파이프라인 변수의 키는 REPORTER                              | 예(상황에 따라 CI 변수 설정 또는 수동 설정에서 작성) | 없음          |
| projectID     | 저장소 ID                                                                                                       | 일반적으로 수동 설정 필요 없음(CI Provider 자동 감지) | 없음          |
| sha           | Git Commit SHA                                                                                                | 일반적으로 수동 설정 필요 없음(CI Provider 자동 감지) | 없음          |
| branch        | Git 저장소 브랜치                                                                                              | 일반적으로 수동 설정 필요 없음(CI Provider 자동 감지) | 없음          |
| reportID      | 다른 테스트 케이스를 구분하기 위해 사용                                                                        | 선택 사항                                      | 없음          |
| compareTarget | 비교 대상, 현재 SHA의 기준선으로 사용되며 변경된 라인의 커버리지를 계산하는 데 사용                            | 선택 사항                                      | 없음          |
| keepMap       | coverage map 유지, 선택 사항, 기본값은 true, false일 경우 .canyon_output 파일이 생성됩니다                     | 선택 사항                                      | true          |
| instrumentCwd | 계측 작업 디렉토리, 다중 저장소 모드에서는 수동 설정이 필요할 수 있음                                          | 선택 사항                                      | process.cwd() |
| provider      | 소스 코드 provider(선택 사항), 기본값은 gitlab                                                                 | 선택 사항                                      | gitlab        |
| oneByOne      | 프록시 서버 설정, 선택 사항, 기본값은 false. true일 경우 컴파일 시 각 파일의 초기 커버리지 데이터를 개별적으로 보고합니다. 프록시 서버 설정일 수도 있습니다. | 선택 사항                                      | false         |

import { Callout } from "nextra/components";

# hit와 map 분리

CI에서 babel 컴파일에 참여하여 생성된 초기 커버리지 소스 파일 수집

## 이유

1. **컴파일에 참여한 전체 파일 수집**: 컴파일 후 과정에서 `babel-plugin-canyon` 플러그인을 통해 
   각 컴파일 참여 파일의 초기 커버리지 파일을 분석하고 `.canyon_out` 폴더에 저장합니다.

2. **미리 수집하여 부담 감소**: 초기 커버리지 파일을 미리 보고하지 않으면 UI 자동화 테스트 중에 이러한 커버리지 파일을 모두 보고하게 됩니다.
   이는 엄청난 전송 부담을 초래합니다. 미리 수집하면 전송 부담을 90% 이상 줄일 수 있습니다.

> [!TIP]
>
> 이것은 필수는 아니지만, 정확하고 안정적인 커버리지 데이터 수집이 필요하다면 강력히 구성을 권장합니다.

## 초기 커버리지 데이터 보고

babel-plugin-canyon 플러그인은 컴파일 시 컴파일에 참여한 파일의 원본 커버리지 파일을 생성하여 .canyon_output 폴더에 저장합니다. 우리는 canyon-uploader 명령줄 도구를 제공하며, CI에서 Canyon 서버에 보고할 수 있습니다.

```yml filename=".github/workflows/report-canyon-output.yml" {19,20} copy
name: Report Canyon Output

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18" # 프로젝트 요구 사항에 따라 Node.js 버전을 수정할 수 있습니다
      - name: Install dependencies
        run: npm install
      - name: Generate output
        run: npm run build

      # .canyon_output 파일 내용 보고
      - name: Report output
        run: canyon-uploader map --dsn=https://canyonjs.org
```

## babel 플러그인 업데이트

keepMap 옵션을 false로 설정

```js filename="babel.config.js" {7} copy
module.exports = {
  plugins: [
    "istanbul",
    [
      "canyon",
      {
        keepMap: false,
      },
    ],
  ],
};
```

## 준비 완료

이제 페이지의 window.coverage 객체를 확인해보세요(스크린샷 참조). window.coverage에는 더 이상 map 데이터가 없으며, 이를 통해
UI 자동화 커버리지 수집 과정에서 많은 전송 비용을 크게 줄일 수 있습니다.

![](https://cdn.jsdelivr.net/gh/canyon-project/assets/docs/static/jietu1.png)

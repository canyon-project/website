import { GithubOutlined } from "@ant-design/icons";
import { Button } from "antd";

# babel-plugin-canyon

<div className={'h-10'}></div>

<Button target={'_blank'} href={'https://github.com/canyon-project/canyon/tree/main/plugins/babel-plugin-canyon'} icon={<GithubOutlined />} size={'small'}>Source</Button>

一款 Babel 插件，用於偵測 CI 環境變量。配合 istanbuljs 完成代碼插樁。

## 使用

安裝:

```sh
npm install --save-dev babel-plugin-canyon
```

在 `babel.config.js` 中添加這些配置:

```js
module.exports = {
  plugins:
    process.env.CI_COMMIT_REF_NAME === "test-coverage"
      ? ["istanbul", "canyon"]
      : [],
      // 需注意插件順序，canyon插件應在istanbul插件之後
};
```

它會做兩件事情：

1. 偵測 CI 流水線變量
2. 檢查上一步istanbul插樁產物並保存到本地(keepMap為false時)

## 配置

babel.config.js

```js
module.exports = {
  plugins: [
    "istanbul",
    [
      "canyon",
      {
        // #region == Step 1: CI 變量配置 或者 手動顯示配置
        dsn: "http://yourdomain.com/coverage/client", // 覆蓋率上報地址，偵測CI流水線變量的KEY為 DSN
        reporter: "your_token", // 用戶token，用於區分不同的用戶，偵測CI流水線變量的KEY為 REPORTER
        // #endregion
        // #region == Step 2: CI Provider 自動偵測，一般不需要手動配置，具體請查看 Support Provider 文檔
        projectID: "230614", // 倉庫ID
        sha: "xxxxxxxxx", // Git Commit SHA
        branch: "master", // Git 倉庫分支
        // #endregion
        // #region == Step 3: 覆蓋率額外功能配置(可選)
        reportID: "case_id", // 用於區分不同的測試用例
        compareTarget: "develop", // 比較目標，用作當前 SHA 的基線，用於計算更改行的覆蓋率
        // #endregion
        // #region == Step 4: hit和map數據分離(可選)
        keepMap: true, // 保留coverage map，可選，默認為true，為false時，會生成.canyon_output文件!!!
        // #endregion
        // #region == Step 5: 其他配置(可選)
        instrumentCwd: "/path/to", // 插樁的工作目錄，多倉庫模式時可能需要手動配置
        provider: "gitlab", // 源代碼 provider(可選)，默認為 gitlab
        oneByOne: false, // 配置代理服務器，可選，默認為false。為true時會在編譯時逐一上報每個文件的初始覆蓋率數據。也可以是代理服務器配置。
        // #endregion
      },
    ],
  ],
};
```

| 配置項        | 描述                                                                                                          | 是否必填                                       | 默認值        |
| ------------- | ------------------------------------------------------------------------------------------------------------- | ---------------------------------------------- | ------------- |
| dsn           | 覆蓋率上報地址，偵測CI流水線變量的KEY為 DSN                                                                   | 是（根據情況在CI變量配置或手動顯示配置中填寫） | 無            |
| reporter      | 用戶token，用於區分不同的用戶，偵測CI流水線變量的KEY為 REPORTER                                               | 是（根據情況在CI變量配置或手動顯示配置中填寫） | 無            |
| projectID     | 倉庫ID                                                                                                        | 一般不需要手動配置（自動偵測CI Provider）      | 無            |
| sha           | Git Commit SHA                                                                                                | 一般不需要手動配置（自動偵測CI Provider）      | 無            |
| branch        | Git倉庫分支                                                                                                   | 一般不需要手動配置（自動偵測CI Provider）      | 無            |
| reportID      | 用於區分不同的測試用例                                                                                        | 可選                                           | 無            |
| compareTarget | 比較目標，用作當前SHA的基線，用於計算更改行的覆蓋率                                                           | 可選                                           | 無            |
| keepMap       | 保留coverage map，可選，默認為true，為false時，會生成.canyon_output文件                                       | 可選                                           | true          |
| instrumentCwd | 插樁的工作目錄，多倉庫模式時可能需要手動配置                                                                  | 可選                                           | process.cwd() |
| provider      | 源代碼provider（可選），默認為gitlab                                                                          | 可選                                           | gitlab        |
| oneByOne      | 配置代理服務器，可選，默認為false。為true時會在編譯時逐一上報每個文件的初始覆蓋率數據。也可以是代理服務器配置 | 可選                                           | false         |

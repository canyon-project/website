import { Callout } from "nextra/components";

# 分離 hit 和 map

在 CI 中收集參與 babel 編譯產生的初始覆蓋率源文件

## 原因

1. **收集完整的參與編譯文件**: 在編譯後過程中，通過 `babel-plugin-canyon` 插件，分析解析
   每個參與編譯文件的覆蓋初始文件，並保存至 `.canyon_out` 文件夾。

2. **提前收集，減輕壓力**: 當您沒有上報初始覆蓋率文件，UI 自動化測試中都會上報這些覆蓋率文件
   這會產生巨大的傳輸壓力。提前收集可以減少 90% 以上的傳輸壓力。

> [!TIP]
>
> 這不是必須的，但是如果您需要準確、穩定的收集覆蓋率數據，強烈建議您配置。

## 上報初始覆蓋率數據

babel-plugin-canyon 插件在編譯時會生成參與編譯文件的原始出覆蓋率文件並保存至 .canyon_output 文件夾，我們提供了 canyon-uploader 的命令行工具，您可在 CI 中上報至 Canyon 服務端。

```yml filename=".github/workflows/report-canyon-output.yml" {19,20} copy
name: Report Canyon Output

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18" # 可以根據項目需求修改 Node.js 版本
      - name: Install dependencies
        run: npm install
      - name: Generate output
        run: npm run build

      # 上報 .canyon_output 文件內容
      - name: Report output
        run: canyon-uploader map --dsn=https://canyonjs.org
```

## 更新 babel 插件

配置 keepMap 選項為 false

```js filename="babel.config.js" {7} copy
module.exports = {
  plugins: [
    "istanbul",
    [
      "canyon",
      {
        keepMap: false,
      },
    ],
  ],
};
```

## 準備好了

此時檢查頁面的 window.coverage 對象，看截圖。window.coverage 中已經沒有 map 數據，這樣
可以大大減輕 UI 自動化覆蓋率收集過程中的大量傳輸成本。

![](https://cdn.jsdelivr.net/gh/canyon-project/assets/docs/static/jietu1.png)

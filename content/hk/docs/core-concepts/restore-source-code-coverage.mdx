# 還原源碼覆蓋率

前端應用編譯形態各異，很多情況下是經過預編譯後的 AST 交由 babel 進行轉換，這樣導致覆蓋率無法直接映射到源碼上，因此我們需要還原源碼覆蓋率。

## Source Map

>
> 在前端開發中，通常會對 JavaScript 代碼進行壓縮、混淆或使用預處理器（如 TypeScript、Babel）進行轉換，以提高性能和兼容性。這些處理會使得最終部署到生產環境的代碼與原始源代碼差異很大，導致調試變得困難。Source Map 解決了這個問題，它記錄了編譯後代碼與原始代碼之間的映射關係，使得開發者能夠在瀏覽器的開發者工具中查看和調試原始代碼。 -- [web.dev](https://web.dev/articles/source-maps)

大多數情況下，您不需要手動獲取 sourceMap 文件，因為大多數構建工具都會在 `預編譯後的 AST 交由 babel 進行轉換` 的這個過程中傳遞了 sourceMap 文件。

但是在某些情況下，您可能需要配置 sourceMap 文件。

## 開啟 sourceMap 選項的情況

```js filename="webpack.config.js" {4}
const path = require('path');

module.exports = {
  entry: './build/main.js',
  output: {
    path: path.resolve(__dirname, 'dist'),
    filename: 'bundle.js'
  },
  module:{
    rules: [
      {
        test: /\.(js|jsx)$/,
        use:['babel-loader'],
        exclude:'/node_modules/'
      }
    ]
  }
};
```

在這個例子中，webpack 的入口文件是 `./build/main.js`，這是 tsc 編譯 ts 文件的產物。我們需要將 tsconfig.json 中的 `sourceMap` 設置為 `true`，__才能保證 sourceMap 數據的傳遞。__

```json filename="tsconfig.json" {3}
{
  "compilerOptions": {
    "sourceMap": true
  }
}
```

## 手動設置 sourceMap 的情況

當您的 sourceMap 生成的方式為以下情況時，您需要手動設置 sourceMap。

| 分類              | devtool                       |  描述                                    |
|-------------------|-------------------------------|-----------------------------------------|
| 生成 source map 文件，不顯示源碼   | hidden-source-map             |  文件未尾不引用 map 文件                 |
| 生成 source map 文件，不顯示源碼   | nosources-source-map           | 文件未尾不引用 map 文件                 |

### 如何手動設置 sourceMap

此時您需要使用到[分離 hit 和 map](/docs/core-concepts/separate-hit-and-map)，通過 `canyon-uploader` 在構建階段偵測本地的 sourceMap 文件，Canyon 會將它們與覆蓋率初始數據匹配上傳。

> [!NOTE]
>
> 這也是 javascript 過於靈活的一個缺點，想要收集到準確的源碼覆蓋率數據，我們需要串聯起這些 sourceMap 文件，讓代碼插樁能夠正確地映射到源碼上。

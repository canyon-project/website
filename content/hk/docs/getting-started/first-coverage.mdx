import { Steps, Callout, Cards } from "nextra/components";

# 第一個覆蓋率數據

> [!NOTE]
>
> Canyon 提供[常見框架的安裝指南](/docs/installation/getting-started)，幫助您快速上手。

跟著以下步驟完成第一個覆蓋率數據上報：

## 作為新項目開始

<Steps>
  ### 安裝

在前端工程化和模塊化開發中離不開Babel，對於Babel項目只需安裝兩個Babel插件，即可快速開始。

```sh npm2yarn
npm install babel-plugin-istanbul babel-plugin-canyon -D
```

在 [Babel 配置文件](https://babeljs.io/docs/config-files#configuration-file-types) 中添加 [`istanbul`](https://www.npmjs.com/package/babel-plugin-istanbul) 和 [`canyon`](https://www.npmjs.com/package/babel-plugin-canyon) 插件：

  ```js filename="babel.config.js" {3,4} copy
  module.exports = {
    plugins: [
      'istanbul',
      'canyon'
      // 需注意插件順序，canyon插件應在istanbul插件之後
      ],
  };
  ```

### 檢查

配置完成後，啟動項目並在控制台打印 **window.\_\_coverage\_\_**。如果輸出與下圖一致，則表示代碼插樁成功。

![coverage-canyon-console](https://cdn.jsdelivr.net/gh/canyon-project/assets/docs/static/docs/getting-started/first-coverage/coverage-canyon-console.png)

### 配置 CI 環境變量

在 CI 環境中，我們需要配置一些環境變量以便上報覆蓋率數據。

> [!TIP]
>
> canyon會在編譯時偵測流水線變量，我們適配了多個[流水線供應商](/docs/reference/provider)。<br/>
> 沒有您的流水線供應商？嘗試[顯式配置](/docs/ecosystem/babel-plugin-canyon#配置)。


1. `DSN` 和 `REPORTER`

- **DSN**：覆蓋率數據上報的服務地址，\{\{url\}\}/coverage/client，其中 \{\{url\}\} 為 Canyon 服務地址。
- **REPORTER**：用戶 token，可在Canyon用戶設置頁面查看。

2. 配置 CI 平台變量

![gitlab](https://cdn.jsdelivr.net/gh/canyon-project/assets/docs/static/docs/getting-started/first-coverage/gitlab-var-config.png)

<Callout type="info" emoji="ℹ️">
  其中，項目 ID、分支和 SHA 無需手動配置，Canyon 插件會自動偵測流水線環境變量。
</Callout>

  ### 更新babel插件生效條件

  __在 CI 階段，我們需要控制插件生效的條件，以防止在生產分支插樁。__

  ```js {2,3} copy
  module.exports = {
    plugins: (process.env.CI &&
              process.env.CI_COMMIT_REF_NAME !== 'release')
              ? [
                'canyon',
                'istanbul'
              ]:[],
  };
  ```

  ### 上報覆蓋率數據

  等待 CI 完成後，頁面發布到測試環境。

  此時，覆蓋率數據已存儲在瀏覽器中。隨著用戶操作或UI自動化測試的執行，window.__coverage___數據會不斷累積。

  將這些數據準確無誤的上報至 Canyon 服務端，即可實現覆蓋率數據的實時展示。


  以下是上報覆蓋率數據的幾種方式：

  <Cards>
  <Cards.Card
    title="UI 自動化測試"
    href="/docs/end-to-end-testing/playwright"
  />
  <Cards.Card
    title="手動測試"
    href="/docs/ecosystem/canyon-extension"
  />
</Cards>
</Steps>
